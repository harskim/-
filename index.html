<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œí‡´ê·¼ ê¸°ë¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-info {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .setup-form {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            font-size: 14px;
            padding: 10px;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .clock {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }
        
        .clock-time {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .clock-date {
            font-size: 18px;
            color: #666;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .stats-title {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stats-value {
            font-size: 36px;
            font-weight: bold;
        }
        
        .table-container {
            margin-top: 20px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .records-table th {
            background: #f5f5f5;
            padding: 18px 8px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
            word-break: keep-all;
            line-height: 1.5;
        }
        
        .records-table td {
            padding: 18px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
            font-size: 14px;
            word-break: break-word;
            line-height: 1.5;
        }
        
        .records-table tr:hover {
            background: #f9f9f9;
        }
        

            width: 25%;
        }
        
        .records-table th:nth-child(2),
        .records-table td:nth-child(2),
        .records-table th:nth-child(3),
        .records-table td:nth-child(3) {
            width: 15%;
        }
        
        .records-table th:nth-child(4),
        .records-table td:nth-child(4) {
            width: 25%;
        }
        
        .records-table th:nth-child(5),
        .records-table td:nth-child(5) {
            width: 20%;
        } 20%;
        }
        
        /* ìˆ˜ì • ë²„íŠ¼ ì—´ */
        .records-table th:nth-child(5),
        .records-table td:nth-child(5) {
            width: 20%;
        }
        
        @media (max-width: 600px) {
            .records-table th {
                font-size: 11px;
                padding: 8px 2px;
            }
            
            .records-table td {
                font-size: 11px;
                padding: 8px 2px;
            }
            
            .btn-edit {
                padding: 4px 6px;
                font-size: 10px;
            }
            
            /* ë‚ ì§œ ì—´ */
            .records-table th:nth-child(1),
            .records-table td:nth-child(1) {
                width: 28%;
                font-size: 10px;
            }
            
            /* ì¶œê·¼/í‡´ê·¼ ì—´ */
            .records-table th:nth-child(2),
            .records-table td:nth-child(2),
            .records-table th:nth-child(3),
            .records-table td:nth-child(3) {
                width: 15%;
            }
            
            /* ê·¼ë¬´ì‹œê°„ ì—´ */
            .records-table th:nth-child(4),
            .records-table td:nth-child(4) {
                width: 22%;
                font-size: 10px;
            }
            
            /* ìˆ˜ì • ë²„íŠ¼ ì—´ */
            .records-table th:nth-child(5),
            .records-table td:nth-child(5) {
                width: 20%;
            }
        }
        
        .helper-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
        }
        
        .modal-footer button {
            flex: 1;
        }
        
        .time-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .time-input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ì¶œí‡´ê·¼ ê¸°ë¡</h1>
            <div class="user-info" id="userInfo">ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('attendance')">ì¶œí‡´ê·¼</button>
            <button class="tab" onclick="showTab('stats')">í†µê³„</button>
            <button class="tab" onclick="showTab('settings')">ì„¤ì •</button>
        </div>
        
        <div class="content">
            <!-- ì¶œí‡´ê·¼ íƒ­ -->
            <div id="attendance" class="tab-content active">
                <div class="clock">
                    <div class="clock-time" id="currentTime">00:00:00</div>
                    <div class="clock-date" id="currentDate">0000ë…„ 00ì›” 00ì¼ (ì›”)</div>
                </div>
                
                <div id="todayStatus" class="status status-info">
                    ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                </div>
                
                <button class="btn btn-success" onclick="checkIn()">
                    âœ… ì¶œê·¼í•˜ê¸°
                </button>
                <button class="btn btn-danger" onclick="checkOut()">
                    ğŸ  í‡´ê·¼í•˜ê¸°
                </button>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="openLeaveModal('ë°˜ì°¨')">
                        ğŸ• ë°˜ì°¨
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="openLeaveModal('ì—°ì°¨')">
                        ğŸŒ´ ì—°ì°¨
                    </button>
                </div>
            </div>
            
            <!-- í†µê³„ íƒ­ -->
            <div id="stats" class="tab-content">
                <div class="stats-card">
                    <div class="stats-title">ì´ë²ˆ ì£¼ ì´ ê·¼ë¬´ì‹œê°„</div>
                    <div class="stats-value" id="weeklyHours">0ì‹œê°„</div>
                </div>
                
                <h3 style="margin-bottom: 15px;">
                    ğŸ“Š ìµœê·¼ ì¶œí‡´ê·¼ ê¸°ë¡
                    <a href="https://docs.google.com/spreadsheets/d/1Xt457YuxZlds84HCnyWY_3cHc_dA-VR8ux1BeAmlv28/edit?gid=1000893127#gid=1000893127" 
                       target="_blank" 
                       style="font-size: 14px; color: #667eea; text-decoration: none; margin-left: 10px;">
                        [ê´€ë¦¬ ì‹œíŠ¸ ë§í¬]
                    </a>
                </h3>
                <div id="recordsList" class="loading">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ì„¤ì • íƒ­ -->
            <div id="settings" class="tab-content">
                <div class="setup-form">
                    <div class="alert alert-info">
                        <strong>â„¹ï¸ ì•ˆë‚´</strong><br>
                        ì²˜ìŒ ì‚¬ìš© ì‹œ ì´ë¦„ê³¼ ê´€ë¦¬ìì—ê²Œ ë°›ì€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                        ì…ë ¥í•œ ì´ë¦„ìœ¼ë¡œ ìë™ìœ¼ë¡œ ì‹œíŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.
                    </div>
                    
                    <div class="form-group">
                        <label>ì´ë¦„ (ì‹œíŠ¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë¨)</label>
                        <input type="text" id="userName" placeholder="í™ê¸¸ë™">
                        <div class="helper-text">
                            Google Sheetsì— ì´ ì´ë¦„ìœ¼ë¡œ ì‹œíŠ¸ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Google Apps Script ì›¹ ì•± URL</label>
                        <input type="url" id="sheetUrl" placeholder="https://script.google.com/macros/s/...">
                        <div class="helper-text">
                            ê´€ë¦¬ìì—ê²Œ ë°›ì€ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš” (í•œ ë²ˆë§Œ ì…ë ¥)
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSettings()">
                        ğŸ’¾ ì„¤ì • ì €ì¥
                    </button>
                    
                    <button class="btn btn-secondary" onclick="clearSettings()">
                        ğŸ—‘ï¸ ì„¤ì • ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">â° ì¶œí‡´ê·¼ ì‹œê°„ ìˆ˜ì •</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="text" id="editDate" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>ì¶œê·¼ ì‹œê°„</label>
                    <input type="time" id="editCheckIn" class="time-input">
                </div>
                <div class="form-group">
                    <label>í‡´ê·¼ ì‹œê°„</label>
                    <input type="time" id="editCheckOut" class="time-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ë°˜ì°¨/ì—°ì°¨ ëª¨ë‹¬ -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="leaveModalTitle">ğŸ“… ë‚ ì§œ ì„ íƒ</div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="leaveTypeLabel">ë°˜ì°¨ ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="leaveDate" class="time-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLeaveModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveLeave()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ ê´€ë¦¬ì: ì—¬ê¸°ì— ë°°í¬í•œ ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)
        const DEFAULT_SHEET_URL = '';  // ì˜ˆ: 'https://script.google.com/macros/s/...'
        
        let userData = {
            name: '',
            sheetUrl: DEFAULT_SHEET_URL
        };
        
        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSettings() {
            const saved = localStorage.getItem('attendanceSettings');
            if (saved) {
                userData = JSON.parse(saved);
                document.getElementById('userName').value = userData.name;
                document.getElementById('sheetUrl').value = userData.sheetUrl;
                document.getElementById('userInfo').textContent = `${userData.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
                loadRecords();
            }
            
            // DEFAULT_SHEET_URLì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì±„ìš°ê¸°
            if (DEFAULT_SHEET_URL && !userData.sheetUrl) {
                document.getElementById('sheetUrl').value = DEFAULT_SHEET_URL;
            }
        }
        
        // ì„¤ì • ì €ì¥
        function saveSettings() {
            const name = document.getElementById('userName').value.trim();
            let sheetUrl = document.getElementById('sheetUrl').value.trim();
            
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (!sheetUrl) {
                if (DEFAULT_SHEET_URL) {
                    sheetUrl = DEFAULT_SHEET_URL;
                } else {
                    alert('Google Apps Script URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }
            }
            
            userData = { name, sheetUrl };
            localStorage.setItem('attendanceSettings', JSON.stringify(userData));
            document.getElementById('userInfo').textContent = `${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
            alert(`ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n"${name}" ì‹œíŠ¸ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.`);
            showTab('attendance');
            loadRecords();
        }
        
        // ì„¤ì • ì´ˆê¸°í™”
        function clearSettings() {
            if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('attendanceSettings');
                userData = { name: '', sheetUrl: DEFAULT_SHEET_URL };
                document.getElementById('userName').value = '';
                document.getElementById('sheetUrl').value = DEFAULT_SHEET_URL;
                document.getElementById('userInfo').textContent = 'ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”';
                alert('ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour12: false });
            const dateStr = now.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }
        
        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'stats') {
                loadRecords();
            }
        }
        
        // ë‚ ì§œ í¬ë§· (ìš”ì¼ í¬í•¨)
        function formatDate(date) {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dayOfWeek = days[date.getDay()];
            return `${year}-${month}-${day}(${dayOfWeek})`;
        }
        
        // ê·¼ë¬´ì‹œê°„ ê³„ì‚° (ì ì‹¬ì‹œê°„ ì œì™¸)
        function calculateWorkHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return '';
            
            const [inH, inM] = checkIn.split(':').map(Number);
            const [outH, outM] = checkOut.split(':').map(Number);
            
            let totalMinutes = (outH * 60 + outM) - (inH * 60 + inM);
            
            // ì ì‹¬ì‹œê°„ 11:20~12:20 ì œì™¸
            const lunchStart = 11 * 60 + 20;
            const lunchEnd = 12 * 60 + 20;
            const checkInMinutes = inH * 60 + inM;
            const checkOutMinutes = outH * 60 + outM;
            
            if (checkInMinutes < lunchEnd && checkOutMinutes > lunchStart) {
                totalMinutes -= 60;
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        }
        
        // ì¶œê·¼
        async function checkIn() {
            if (!userData.name || !userData.sheetUrl) {
                alert('ì„¤ì • íƒ­ì—ì„œ ì´ë¦„ê³¼ URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                showTab('settings');
                return;
            }
            
            const now = new Date();
            const date = formatDate(now);
            const time = now.toTimeString().slice(0, 5);
            
            try {
                await fetch(userData.sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userName: userData.name,
                        date: date,
                        checkIn: time,
                        checkOut: '',
                        workHours: ''
                    })
                });
                
                alert(`ì¶œê·¼ ê¸°ë¡ ì™„ë£Œ!\nì‹œê°„: ${time}`);
                updateTodayStatus(date, time, '', '');
                
                // ì¦‰ì‹œ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadRecords, 1000);
            } catch (error) {
                alert('ì¶œê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
        
        // í‡´ê·¼
        async function checkOut() {
            if (!userData.name || !userData.sheetUrl) {
                alert('ì„¤ì • íƒ­ì—ì„œ ì´ë¦„ê³¼ URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                showTab('settings');
                return;
            }
            
            const now = new Date();
            const date = formatDate(now);
            const time = now.toTimeString().slice(0, 5);
            
            // ì˜¤ëŠ˜ ì¶œê·¼ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
            const records = await loadRecordsData();
            const todayRecord = records.find(r => r.date === date);
            
            if (!todayRecord || !todayRecord.checkIn) {
                alert('ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶œê·¼í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const workHours = calculateWorkHours(todayRecord.checkIn, time);
            
            try {
                await fetch(userData.sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userName: userData.name,
                        date: date,
                        checkIn: todayRecord.checkIn,
                        checkOut: time,
                        workHours: workHours
                    })
                });
                
                alert(`í‡´ê·¼ ê¸°ë¡ ì™„ë£Œ!\nì‹œê°„: ${time}\nê·¼ë¬´ì‹œê°„: ${workHours}`);
                updateTodayStatus(date, todayRecord.checkIn, time, workHours);
                
                // ì¦‰ì‹œ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadRecords, 1000);
            } catch (error) {
                alert('í‡´ê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
        
        // ì˜¤ëŠ˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateTodayStatus(date, checkIn, checkOut, workHours) {
            const statusDiv = document.getElementById('todayStatus');
            
            if (checkIn && checkOut) {
                statusDiv.className = 'status status-success';
                statusDiv.innerHTML = `
                    <strong>ì˜¤ëŠ˜ (${date})</strong><br>
                    ì¶œê·¼: ${checkIn} | í‡´ê·¼: ${checkOut}<br>
                    ê·¼ë¬´ì‹œê°„: ${workHours}
                `;
            } else if (checkIn) {
                statusDiv.className = 'status status-info';
                statusDiv.innerHTML = `
                    <strong>ì˜¤ëŠ˜ (${date})</strong><br>
                    ì¶œê·¼: ${checkIn} | í‡´ê·¼ ì „
                `;
            }
        }
        
        // ê¸°ë¡ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadRecordsData() {
            if (!userData.name || !userData.sheetUrl) return [];
            
            try {
                const url = `${userData.sheetUrl}?userName=${encodeURIComponent(userData.name)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.data : [];
            } catch (error) {
                console.error('ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return [];
            }
        }
        
        // ê¸°ë¡ í‘œì‹œ
        async function loadRecords() {
            if (!userData.name || !userData.sheetUrl) {
                document.getElementById('recordsList').innerHTML = '<p style="text-align: center; color: #999;">ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>';
                return;
            }
            
            const recordsList = document.getElementById('recordsList');
            recordsList.innerHTML = '<div class="loading">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            const records = await loadRecordsData();
            
            if (records.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                document.getElementById('weeklyHours').textContent = '0ì‹œê°„';
                return;
            }
            
            // ì´ë²ˆ ì£¼ ê·¼ë¬´ì‹œê°„ ê³„ì‚°
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            let weeklyMinutes = 0;
            records.forEach(record => {
                try {
                    const recordDate = new Date(record.date.split('(')[0]);
                    if (recordDate >= weekStart && record.workHours) {
                        const match = record.workHours.match(/(\d+)ì‹œê°„ (\d+)ë¶„/);
                        if (match) {
                            weeklyMinutes += parseInt(match[1]) * 60 + parseInt(match[2]);
                        }
                    }
                } catch (e) {
                    console.error('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            });
            
            const weeklyHours = Math.floor(weeklyMinutes / 60);
            const weeklyMins = weeklyMinutes % 60;
            document.getElementById('weeklyHours').textContent = `${weeklyHours}ì‹œê°„ ${weeklyMins}ë¶„`;
            
            // ìµœê·¼ 10ê°œ ê¸°ë¡ í‘œì‹œ
            let html = '<div class="table-container"><table class="records-table"><thead><tr>';
            html += '<th>ë‚ ì§œ</th><th>ì¶œê·¼</th><th>í‡´ê·¼</th><th>ê·¼ë¬´ì‹œê°„</th><th>ë¹„ê³ </th><th>ìˆ˜ì •</th>';
            html += '</tr></thead><tbody>';
            
            records.slice(-10).reverse().forEach(record => {
                html += `<tr>
                    <td>${record.date || '-'}</td>
                    <td>${record.checkIn || '-'}</td>
                    <td>${record.checkOut || '-'}</td>
                    <td>${record.workHours || '-'}</td>
                    <td>${record.note || '-'}</td>
                    <td><button class="btn-edit" onclick='openEditModal(${JSON.stringify(record)})'>ìˆ˜ì •</button></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            recordsList.innerHTML = html;
            
            // ì˜¤ëŠ˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            const todayDate = formatDate(today);
            const todayRecord = records.find(r => r.date === todayDate);
            if (todayRecord) {
                updateTodayStatus(todayDate, todayRecord.checkIn, todayRecord.checkOut, todayRecord.workHours);
            }
        }
        
        // ì´ˆê¸°í™”
        loadSettings();
        updateClock();
        setInterval(updateClock, 1000);
        
        // 5ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
        setInterval(() => {
            if (userData.name && userData.sheetUrl) {
                loadRecords();
            }
        }, 300000);
        
        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEditModal(record) {
            document.getElementById('editDate').value = record.date;
            document.getElementById('editCheckIn').value = record.checkIn || '';
            document.getElementById('editCheckOut').value = record.checkOut || '';
            document.getElementById('editModal').classList.add('active');
        }
        
        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        // ìˆ˜ì • ì €ì¥
        async function saveEdit() {
            const date = document.getElementById('editDate').value;
            const checkIn = document.getElementById('editCheckIn').value;
            const checkOut = document.getElementById('editCheckOut').value;
            
            if (!checkIn) {
                alert('ì¶œê·¼ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const workHours = calculateWorkHours(checkIn, checkOut);
            
            try {
                await fetch(userData.sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userName: userData.name,
                        date: date,
                        checkIn: checkIn,
                        checkOut: checkOut,
                        workHours: workHours
                    })
                });
                
                alert('ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeEditModal();
                
                // ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadRecords, 1000);
                
                // ì˜¤ëŠ˜ ë‚ ì§œë©´ ìƒíƒœë„ ì—…ë°ì´íŠ¸
                const today = formatDate(new Date());
                if (date === today) {
                    updateTodayStatus(date, checkIn, checkOut, workHours);
                }
            } catch (error) {
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        document.getElementById('leaveModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLeaveModal();
            }
        });
        
        // ë°˜ì°¨/ì—°ì°¨ ëª¨ë‹¬
        let currentLeaveType = '';
        
        function openLeaveModal(type) {
            if (!userData.name || !userData.sheetUrl) {
                alert('ì„¤ì • íƒ­ì—ì„œ ì´ë¦„ê³¼ URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                showTab('settings');
                return;
            }
            
            currentLeaveType = type;
            document.getElementById('leaveModalTitle').textContent = type === 'ë°˜ì°¨' ? 'ğŸ• ë°˜ì°¨ ì‹ ì²­' : 'ğŸŒ´ ì—°ì°¨ ì‹ ì²­';
            document.getElementById('leaveTypeLabel').textContent = `${type} ë‚ ì§œ ì„ íƒ`;
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').value = today;
            
            document.getElementById('leaveModal').classList.add('active');
        }
        
        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.remove('active');
        }
        
        async function saveLeave() {
            const dateInput = document.getElementById('leaveDate').value;
            if (!dateInput) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ë‚ ì§œë¥¼ ìš”ì¼ í¬í•¨ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const selectedDate = new Date(dateInput + 'T00:00:00');
            const formattedDate = formatDate(selectedDate);
            
            // ë°˜ì°¨: 4ì‹œê°„, ì—°ì°¨: 8ì‹œê°„
            const workHours = currentLeaveType === 'ë°˜ì°¨' ? '4ì‹œê°„ 0ë¶„' : '8ì‹œê°„ 0ë¶„';
            const note = currentLeaveType;
            
            try {
                await fetch(userData.sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userName: userData.name,
                        date: formattedDate,
                        checkIn: '-',
                        checkOut: '-',
                        workHours: workHours,
                        note: note
                    })
                });
                
                alert(`${currentLeaveType} ì‹ ì²­ ì™„ë£Œ!\në‚ ì§œ: ${formattedDate}\nê·¼ë¬´ì‹œê°„: ${workHours}`);
                closeLeaveModal();
                
                // ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadRecords, 1000);
            } catch (error) {
                alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
    </script>
</body>
</html>
